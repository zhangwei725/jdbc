# 数据库事务\(Database Transaction\)

## 一、简介

​    并发控制指的是当多个用户同时更新运行时，用于保护数据库完整性的各种技术。并发机制不正确可能导致脏读、幻读和不可重复读等此类问题。并发控制的目的是保证一个用户的工作不会对另一个用户的工作产生不合理的影响。在某些情况下，这些措施保证了当用户和其他用户一起操作时，所得的结果和她单独操作时的结果是一样的。在另一些情况下，这表示用户的工作按预定的方式受其他用户的影响

事务\(Transaction\):是并发控制的单元，是用户定义的一个操作序列。这些操作要么都做，要么都不做，是一个不可分割的工作单位。通过事务，sql  能将逻辑相关的一组操作绑定在一起，以便服务器 保持数据的完整性。事务通常是以begin transaction开始，以commit或rollback结束。Commint表示提交，即提交事务的所有操作。具体地说就是将事务中所有对数据的更新写回到磁盘上的物理数据库中去，事务正常结束。Rollback表示回滚，即在事务运行的过程中发生了某种故障，事务不能继续进行，系统将事务中对数据库的所有已完成的操作全部撤消，滚回到事务开始的状态

设想网上购物的一次交易，其付款过程至少包括以下几步数据库操作：

1. 更新客户所购商品的库存信息 
2. 保存客户付款信息--可能包括与银行系统的交互 
3. 生成订单并且保存到数据库中
4. 更新用户相关信息，例如购物数量等等  

正常的情况下，这些操作将顺利进行，最终交易成功，与交易相关的所有数据库信息也成功地更新。但是，如果在这一系列过程中任何一个环节出了差错，例如在更新商品库存信息时发生异常、该顾客银行帐户存款不足等，都将导致交易失败。一旦交易失败，数据库中所有信息都必须保持交易前的状态不变，比如最后一步更新用户信息时失败而导致交易失败，那么必须保证这笔失败的交易不影响数据库的状态--库存信息没有被更新、用户也没有付款，订单也没有生成。否则，数据库的信息将会一片混乱而不可预测。

数据库事务正是用来保证这种情况下交易的平稳性和可预测性的技术

JDBC连接是在默认情况下会自动提交，也就是说每个SQL语句都是在其完成时提交到数据库。

事务只针对DML操作

## 二、事务的特性\(ACID\)

1. 举个栗子:A账户向B账号汇钱的例子来说明如何通过数据库事务保证数据的准确性和完整性

   ```
   1、从A账号中把余额读出来（500） 
   2、对A账号做减法操作（500-100）
   3、把结果写回A账号中（400）
   4、从B账号中把余额读出来（500
   5、对B账号做加法操作（500+100） 
   6、把结果写回B账号中（600）
   ```

### 2.1、原子性（atomicity）

```
事务是数据库的逻辑工作单位，而且是必须是原子工作单位，对于其数据修改，要么全部执行，要么全部不执行。
```

```
保证1-6所有过程要么都执行，要么都不执行。一旦在执行某一步骤的过程中发生问题，就需要执行回滚操作。 
假如执行到第五步的时候，B账户突然不可用（比如被注销），那么之前的所有操作都应该回滚到执行事务之前的状态
```

### 2.2、一致性（consistency）

```
事务在完成时，必须是所有的数据都保持一致状态。在相关数据库中，所有规则都必须应用于事务的修改，以保持所有数据的完整性。
```

```
在转账之前，A和B的账户中共有500+500=1000元钱。在转账之后，A和B的账户中共有400+600=1000元。
也就是说，数据的状态在执行该事务操作之后从一个状态改变到了另外一个状态。同时一致性还能保证账户余额不会变成负数等
```

### 2.3、隔离性（isolation）

```
也称为独立性，是指并行事务的修改必须与其他并行事务的修改相互独立。一个事务处理数据，要么是其他事务执行之前的状态，
要么是其他事务执行之后的状态，但不能处理其他正在处理的数据。
企业级的数据库每一秒钟都可能应付成千上万的并发访问，因而带来了并发控制的问题。
```

```
在A向B转账的整个过程中，只要事务还没有提交（commit），查询A账户和B账户的时候，两个账户里面的钱的数量都不会有变化。 
如果在A给B转账的同时，有另外一个事务执行了C给B转账的操作，那么当两个事务都结束的时候，
B账户里面的钱应该是A转给B的钱加上C转给B的钱再加上自己原有的钱
```

### 2.4、持久性（durability）

```
一个事务一旦提交，事物的操作便永久性的保存在DB中。即使此时再执行回滚操作也不能撤消所做的更改
```

```
一旦转账成功（事务提交），两个账户的里面的钱就会真的发生变化（会把数据写入数据库做持久化保存）
```

## 三、JDBC标准事务编程





